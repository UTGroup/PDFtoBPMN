name: Cross-Platform Tests

# ============================================================
# IMPORTANT: Lightweight CI dependencies
# ============================================================
# –≠—Ç–æ—Ç workflow –∏—Å–ø–æ–ª—å–∑—É–µ—Ç requirements-ci.txt (–≤–º–µ—Å—Ç–æ requirements.txt)
# –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
#
# requirements-ci.txt —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û:
#   - PyMuPDF, python-docx, openpyxl, requests, Pillow (~50 MB)
#
# requirements.txt —Å–æ–¥–µ—Ä–∂–∏—Ç –ü–û–õ–ù–´–ô –Ω–∞–±–æ—Ä (–¥–ª—è production):
#   - torch (900 MB), paddlepaddle (189 MB), cuda libs (600 MB+)
#
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç CI –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è –∑–∞ 2-3 –º–∏–Ω—É—Ç—ã –≤–º–µ—Å—Ç–æ 15+ –º–∏–Ω—É—Ç.
# ============================================================

# –¢—Ä–∏–≥–≥–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞ workflow
on:
  # –ü—Ä–∏ –∫–∞–∂–¥–æ–º Push –≤ –ª—é–±—É—é –≤–µ—Ç–∫—É
  push:
    branches: [ "*" ]
  
  # –ü—Ä–∏ –∫–∞–∂–¥–æ–º Pull Request
  pull_request:
    branches: [ "*" ]
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ GitHub UI
  workflow_dispatch:

# –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è GitHub —Ç–æ–∫–µ–Ω–∞
permissions:
  contents: read
  pull-requests: read

jobs:
  # ==================== JOB 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è ====================
  environment-check:
    name: Environment Check (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.8', '3.10', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Display Python version
        run: python --version
      
      - name: Install dependencies (minimal for CI)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt
      
      - name: Run environment check
        run: python scripts/utils/check_environment.py
        # Note: strict mode –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è CI - warnings –æ–∂–∏–¥–∞–µ–º—ã (no venv, no pandoc, no GPU)
  
  # ==================== JOB 2: –õ–∏–Ω—Ç–µ—Ä (—Ç–æ–ª—å–∫–æ Linux) ====================
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black isort
      
      - name: Check code formatting with Black
        run: |
          black --check scripts/ --exclude "venv|DeepSeek-OCR" || echo "‚ö†Ô∏è Black formatting issues found"
        continue-on-error: true
      
      - name: Check imports with isort
        run: |
          isort --check-only scripts/ --skip venv --skip DeepSeek-OCR || echo "‚ö†Ô∏è Import sorting issues found"
        continue-on-error: true
      
      - name: Lint with flake8
        run: |
          # E501: line too long (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, —ç—Ç–æ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞)
          # W503: line break before binary operator (PEP 8 –∏–∑–º–µ–Ω–∏–ª—Å—è)
          flake8 scripts/ --exclude=venv,DeepSeek-OCR --max-line-length=120 --ignore=E501,W503 || echo "‚ö†Ô∏è Flake8 warnings found"
        continue-on-error: true
  
  # ==================== JOB 3: –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã ====================
  unit-tests:
    name: Unit Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: environment-check  # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ env check –ø—Ä–æ—à–µ–ª
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.10']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies (minimal for CI)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt
          pip install pytest pytest-cov
      
      - name: Run unit tests
        run: |
          # –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞–ø–∫–∞ tests/, –∑–∞–ø—É—Å—Ç–∏—Ç—å pytest
          if [ -d "tests" ] || [ -d "Tests" ]; then
            pytest tests/ -v --cov=scripts/pdf_to_context --cov-report=term-missing
          else
            echo "‚ÑπÔ∏è –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (tests/ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)"
            echo "‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –î–æ–±–∞–≤–∏—Ç—å —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"
          fi
        shell: bash
        continue-on-error: true
  
  # ==================== JOB 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã ====================
  integration-tests:
    name: Integration Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: environment-check
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.10']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies (minimal for CI)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt
      
      - name: Test DOCX processing (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Testing run_document.py with DOCX..."
          # –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π DOCX —Ñ–∞–π–ª –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–∑–∂–µ
          echo "‚ÑπÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±—É–¥—É—â–µ–º"
      
      - name: Test DOCX processing (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "Testing run_document.py with DOCX..."
          echo "‚ÑπÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±—É–¥—É—â–µ–º"
  
  # ==================== JOB 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ encoding UTF-8 ====================
  encoding-check:
    name: UTF-8 Encoding Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for files without UTF-8 encoding
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ encoding='utf-8' –≤–æ –≤—Å–µ—Ö Python —Ñ–∞–π–ª–∞—Ö..."
          
          # –ü–æ–∏—Å–∫ open() –±–µ–∑ encoding=
          problematic_files=$(grep -rn "open(" scripts/ --include="*.py" | \
            grep -v "encoding=" | \
            grep -v "fitz.open" | \
            grep -v "Image.open" | \
            grep -v "pdfplumber.open" | \
            grep -v "os.open" | \
            grep -v "os.fdopen" | \
            grep -v "#" || true)
          
          if [ -n "$problematic_files" ]; then
            echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã —Å open() –±–µ–∑ —è–≤–Ω–æ–≥–æ encoding:"
            echo "$problematic_files"
            echo ""
            echo "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –î–æ–±–∞–≤–∏—Ç—å encoding='utf-8' –¥–ª—è –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤"
            # –ù–µ –ø–∞–¥–∞—Ç—å, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
          else
            echo "‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —è–≤–Ω—ã–π encoding"
          fi
      
      - name: Check for non-UTF-8 files
        run: |
          echo "üîç –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ —Å –Ω–µ-UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ Python —Ñ–∞–π–ª–æ–≤
          find scripts/ -name "*.py" -type f | while read file; do
            if ! file "$file" | grep -q "UTF-8"; then
              echo "‚ö†Ô∏è –§–∞–π–ª –Ω–µ –≤ UTF-8: $file"
            fi
          done
          
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
  
  # ==================== JOB 6: –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å ====================
  all-tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [environment-check, lint, unit-tests, integration-tests, encoding-check]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "üìä –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫:"
          echo "  - Environment Check: ${{ needs.environment-check.result }}"
          echo "  - Lint: ${{ needs.lint.result }}"
          echo "  - Unit Tests: ${{ needs.unit-tests.result }}"
          echo "  - Integration Tests: ${{ needs.integration-tests.result }}"
          echo "  - Encoding Check: ${{ needs.encoding-check.result }}"
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
          if [ "${{ needs.environment-check.result }}" != "success" ]; then
            echo "‚ùå Environment check failed!"
            exit 1
          fi
          
          if [ "${{ needs.encoding-check.result }}" != "success" ]; then
            echo "‚ùå Encoding check failed!"
            exit 1
          fi
          
          # Lint –∏ tests –º–æ–≥—É—Ç –±—ã—Ç—å continue-on-error
          echo "‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!"


